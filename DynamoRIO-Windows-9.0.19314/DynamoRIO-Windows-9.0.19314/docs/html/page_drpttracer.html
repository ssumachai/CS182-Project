<!-- HTML header for doxygen 1.8.19-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.19"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
<title>DynamoRIO: Intel PT Tracing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.19 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_drpttracer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Intel PT Tracing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <code>drpttracer</code> DynamoRIO Extension provides clients with tracing functionality via Intel's PT instruction tracing feature.</p>
<dl class="section note"><dt>Note</dt><dd>This extension only works on x86_64 Linux.</dd></dl>
<ul>
<li><a class="el" href="page_drpttracer.html#sec_drpttracer_setup">Setup</a></li>
<li><a class="el" href="page_drpttracer.html#sec_drpttracer_usage">Usage</a></li>
<li><a class="el" href="page_drpttracer.html#sec_drpttracer_tracing_mode">Tracing Mode</a></li>
</ul>
<h1><a class="anchor" id="sec_drpttracer_setup"></a>
Setup</h1>
<p>To use <code>drpttracer</code> with your client simply include this line in your client's <code>CMakeLists.txt</code> file:</p>
<div class="fragment"><div class="line">use_DynamoRIO_extension(clientname drpttracer) </div>
</div><!-- fragment --><p>That will automatically set up the include path and library dependence.</p>
<p>Initialize and clean up <code>drpttracer</code> by calling <a class="el" href="drpttracer_8h.html#a2ce2d81e3de5e6969eb2742f1eab15d2">drpttracer_init()</a> and <a class="el" href="drpttracer_8h.html#a85f7b141497601e4205789e490ca3535">drpttracer_exit()</a>.</p>
<h1><a class="anchor" id="sec_drpttracer_usage"></a>
Usage</h1>
<p>Intel PT (Processor Trace) only logs control flow changes. Therefore, when decoding a trace, the decoder needs to get raw bits of every instruction from images. <code>drpttracer</code> provides APIs to use Intel PT to generate trace data and some auxiliary data to help the decoder (e.g. libipt) to decode the trace. One type of auxiliary data is sideband data. This sideband data stores perf event records, which contain the image change messages necessary for decoding the trace. Another type of auxiliary data is the metadata for a trace. The metadata contains the CPU information and some other information that can be used to synthesize the time of PT trace and the perf event records. The auxiliary data enables the decoder to find the correct raw bits for every instruction.</p>
<p><code>drpttracer</code> uses the pttracer handle to manage the tracing sessions. The handle is a pointer to <code>drpttracer's</code> internal data structure, which contains the tracing's PT data buffer, sideband data buffer, and metadata. To generate a pttracer handle, the client needs to call:</p>
<ul>
<li><a class="el" href="drpttracer_8h.html#a0df98e25ae870fddf34da980f1801f3a">drpttracer_create_handle()</a></li>
</ul>
<p>The create function lets the client specify the following parameters:</p>
<ul>
<li>trace_mode : The tracing mode.</li>
<li>pt_size_shift: The size shift of PT trace's ring buffer. It must be greater than 0, and the buffer size is 2^pt_size_shift * PAGE_SIZE.</li>
<li>sideband_size_shift: The size shift of PT sideband data's ring buffer. It must be greater than 0, and the buffer size is 2^sideband_size_shift * PAGE_SIZE.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Linux perf sets the buffer size to 4MiB by default. Therefore, it is best for clients to set trace and sideband buffers larger than 4Mib.</dd>
<dd>
For one thread, only one tracing can execute at the same time. So the client needs to ensure one thread only owns one pttracer handle.</dd></dl>
<p>The client must ensure that the PT trace's ring buffer and the sideband data's ring buffer is large enough to hold the PT data. Insufficient buffer size will lead to lost data, which may cause issues in <a class="el" href="classpt2ir__t.html">pt2ir_t</a> decoding.</p>
<p>After creating a pttracer handle successfully, the client can start or stop a tracing session by calling <a class="el" href="drpttracer_8h.html#afb2c6fe798b7b3125647d647fb8e7835">drpttracer_start_tracing()</a> and <a class="el" href="drpttracer_8h.html#a75d42188aac044aef56517160b355433">drpttracer_stop_tracing()</a>.</p>
<ul>
<li><a class="el" href="drpttracer_8h.html#afb2c6fe798b7b3125647d647fb8e7835">drpttracer_start_tracing()</a></li>
<li><a class="el" href="drpttracer_8h.html#a75d42188aac044aef56517160b355433">drpttracer_stop_tracing()</a></li>
</ul>
<p>The client must pass a valid trace handle to the start and stop function. And the client can use one handle for multiple tracing sessions. When the tracing is stopped, the stop function will allocate an instance of <a class="el" href="drpttracer_8h.html#a2a039aa7d15f79edcbae537289181000">drpttracer_output_t</a>, and copy the PT data, sideband data, and metadata to a <a class="el" href="drpttracer_8h.html#a2a039aa7d15f79edcbae537289181000">drpttracer_output_t</a> instance which is returned to the client. If drpttracer_end_tracing() detects an overflow, it will return an error status code:</p>
<ul>
<li>Return <a class="el" href="drpttracer_8h.html#a7846187879de367e706edaed0293e45dac3626cf9c2740a80ca15c99e6fba493a">DRPTTRACER_ERROR_OVERWRITTEN_PT_TRACE</a> if the PT trace is overwritten.</li>
<li>Return <a class="el" href="drpttracer_8h.html#a7846187879de367e706edaed0293e45da3beefda8ad4ea9aa597f6a07053c56af">DRPTTRACER_ERROR_OVERWRITTEN_SIDEBAND_DATA</a> if the sideband data is overwritten.</li>
</ul>
<p>After all the tracing sessions are stopped, the client needs to call the following function to free the pttracer handle:</p>
<ul>
<li><a class="el" href="drpttracer_8h.html#ad80d0c63dadc4dac1d21d0caf662f2f9">drpttracer_destroy_handle()</a></li>
</ul>
<p>Additionally, to avoid memory leak, the client must call the following function to destroy the output instances after using them:</p>
<ul>
<li><a class="el" href="drpttracer_8h.html#a6722673d8102754af9c4284f76bc2acf">drpttracer_destroy_output()</a></li>
</ul>
<p>Also, the client can dump the data in the output to different files for offline post-processing. The user can use the library <a class="el" href="classpt2ir__t.html">pt2ir_t</a> in drcachesim to convert the PT trace to DynamoRIO's IR.</p>
<h1><a class="anchor" id="sec_drpttracer_tracing_mode"></a>
Tracing Mode</h1>
<p><code>drpttracer</code> provides three types of tracing modes:</p>
<ul>
<li><a class="el" href="drpttracer_8h.html#ab099a83052a5a8b244083b57ddffcbc5a2a5a1e4a865cb2c334cf8419b2ec56fa">DRPTTRACER_TRACING_ONLY_USER</a></li>
<li><a class="el" href="drpttracer_8h.html#ab099a83052a5a8b244083b57ddffcbc5a567592a17aff204f5a4b194f66eaed0a">DRPTTRACER_TRACING_ONLY_KERNEL</a></li>
<li><a class="el" href="drpttracer_8h.html#ab099a83052a5a8b244083b57ddffcbc5a9d97d6e409ada6de57b31fe55aa0e4db">DRPTTRACER_TRACING_USER_AND_KERNEL</a></li>
</ul>
<p>When starting tracing, the client can choose the tracing mode by passing the appropriate flag to <a class="el" href="drpttracer_8h.html#afb2c6fe798b7b3125647d647fb8e7835">drpttracer_start_tracing()</a>.</p>
<dl class="section note"><dt>Note</dt><dd>For kernel PT traces, the trace data's raw bits are all from kcore. So the output data from <code>drpttracer</code> doesn't contain sideband data; it only contains the trace data and metadata. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.19-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.19314 --- Sat Nov 19 2022 03:14:16 &nbsp; <img border=0 src="favicon.png">
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
